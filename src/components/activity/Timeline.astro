---
import { Collapsible } from '@f0rbit/ui'
import { fetchTimeline, getTimeline } from '../../utils'
import moment from 'moment'
import CommitList from './CommitList.astro'
interface Props {
    limit: number | null
    group_commits: boolean
    project_repo?: string
}

const { limit, group_commits, project_repo = null } = Astro.props

const activity = await fetchTimeline()

let events = getTimeline(activity, group_commits)

if (project_repo) events = events.filter((event: any) => event.permalink && event.permalink.includes(project_repo))

// limit the response
if (limit) events = events.slice(0, limit)
---

<div class="activity-timeline">
    <div class="activity-timeline-line"></div>
    <div style={{ maxWidth: 'min(100%, 90vw)', width: 'min(85vw, 35rem)' }}>
        {
            events.map((event: any) => {
                return (
                    <div class="activity-event">
                        <div class="activity-dot" />
                        <div class="activity-content">
                            <label class="text-sm">{moment(event.date).fromNow()}</label>
                            <h3>{event.title ?? ''}</h3>
                        </div>
                        <div class="activity-detail">
                            {event.category == 'GITHUB' && (
                                <p class="text-sm">
                                    <a href={event.permalink} class="font-mono">
                                        {event.sha.slice(0, 7)}
                                    </a>{' '}
                                    - <a href={`https://github.com/f0rbit/${event.project}`}>forbit/{event.project}</a>
                                </p>
                            )}
                            {event.category == 'COMMITS' &&
                                (event.commits?.length > 5 ? (
                                    <Collapsible client:visible trigger={`${event.commits.length} Commits`}>
                                        <CommitList commits={event.commits} />
                                    </Collapsible>
                                ) : (
                                    <CommitList commits={event.commits} />
                                ))}
                        </div>
                    </div>
                )
            })
        }
    </div>
</div>

<style>
    .activity-timeline {
        position: relative;
        padding-left: 2.5rem;
    }
    .activity-timeline-line {
        position: absolute;
        left: 1.25rem;
        top: 0.75rem;
        bottom: 0;
        width: 1px;
        background: var(--fg-subtle);
    }
    .activity-dot {
        position: absolute;
        left: -1.75rem;
        top: 0.35rem;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--fg-muted);
    }
    .activity-event {
        position: relative;
        margin-bottom: var(--space-sm);
    }
    .activity-detail {
        padding-left: 1.25rem;
    }
    .activity-content {
        display: flex;
        flex-direction: column;
    }
</style>
