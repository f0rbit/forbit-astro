---
import { remark } from 'remark'
import { TECH_MAP, type Technology } from '../../assets/technology'
import type { Project } from '../../types'
import remarkHtml from 'remark-html'
import TechnologyIcon from './TechnologyIcon.astro'
import Status from './Status.astro'
import { Github } from 'lucide-astro'
import { Badge } from "@f0rbit/ui"
import PublishTime from '../blog/PublishTime'
import Timeline from '../activity/Timeline.astro'

interface Props {
    project: Project
}

const { project } = Astro.props

const technologies: Technology[] = TECH_MAP[project.project_id] ?? []

const parsed = project.specification ? await remark().use(remarkHtml).process(project.specification) : null
---

<section class="stack project-main">
<div class="row project-heading">
    <h1>{project.name}</h1>
    {
        project.current_version ? (
            <Badge variant="accent" title={`Current version: ${project.current_version}`}>
                <span>{project.current_version}</span>
            </Badge>
        ) : null
    }
</div>
<div class="cluster text-sm project-meta">
    <Status status={project.status} size={16} />
    {
        project.repo_url && (
            <Badge>
                <a href={project.repo_url} class="row-sm">
                    <Github size={16} />
                    <p>GitHub</p>
                </a>
            </Badge>
        )
    }
    {
        project.link_url && (
            <Badge>
                <a href={project.link_url}>{project.link_text}</a>
            </Badge>
        )
    }
</div>
{
    project.updated_at ? (
        <div class="text-sm project-meta">
            <>
                <span>Last updated </span>
                <PublishTime client:load date={project.updated_at} />
            </>
        </div>
    ) : null
}

<h2 class="project-section-heading">Description</h2>
<p>{project.description}</p>

{
    project.specification ? (
        <>
            <h2 class="project-spec-heading">Specification</h2>
            <article class="specification">{parsed}</article>
        </>
    ) : null
}

{
    technologies.length > 0 ? (
        <>
            <h2 class="project-tech-heading">Technologies</h2>
            <ul class="stack-sm tech-list project-tech-list">
                {technologies.map((tech) => (
                    <div class="row tech-item">
                        <span>â€¢</span>
                        <span class="tech-icon">
                            <TechnologyIcon tech={tech} />
                        </span>
                        <span class="tech-name">{tech}</span>
                    </div>
                ))}
            </ul>
        </>
    ) : null
}
</section>

<section class="stack sidebar">
{
    project.repo_url ? (
        <>
            <h2>Recent Commits</h2>
            <Timeline project_repo={project.repo_url} limit={10} group_commits={false} /> 
        </>
    ) : null
}
</section>

<!-- TODO: screenshots -->

<!-- TODO: recent releases -->


<!-- TODO: roadmap -->

<style>
    .project-main {
        flex-grow: 1;
        width: 100%;
    }
    .project-heading {
        align-items: center;
    }
    .project-meta {
        margin-top: var(--space-xs);
    }
    .project-section-heading {
        margin-top: var(--space-sm);
    }
    .project-spec-heading {
        margin-top: var(--space-sm);
        margin-bottom: calc(-1 * var(--space-sm));
    }
    .project-tech-heading {
        margin-top: var(--space-md);
    }
    .project-tech-list {
        margin-top: 0.125rem;
    }
    .tech-item {
        align-items: center;
    }
    .tech-icon {
        margin-top: 2.2px;
    }
    .tech-name {
        text-transform: capitalize;
    }
    .sidebar {
        width: min(400px, 100%);
    }
</style>
